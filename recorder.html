<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Genealogy Record Editor</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://unpkg.com;">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js" crossorigin="anonymous"></script>
    <script src="config.js"></script>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;font-size:18px;padding:20px;max-width:100%;margin:0 auto}
        .task-buttons{display:flex;flex-wrap:wrap;gap:15px;justify-content:center;margin-bottom:20px}
        .task-btn{font-size:16.2px !important;padding:6.5px 13px !important;min-width:122px !important;border-radius:7.2px;background:#007bff;color:white;border:none;cursor:pointer;touch-action:manipulation}
        .task-btn:hover:not(.disabled-btn){background:#0056b3}
        .disabled-btn{background:#ccc;cursor:not-allowed;pointer-events:none}
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000}
        .modal-content{background:white;padding:20px;border-radius:10px;width:90%;max-width:420px;max-height:80vh;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,0.2)}
        .close{float:right;font-size:24px;cursor:pointer}
        .modal-content h3{margin-top:0;font-size:24px;text-align:center}
        .modal-content label{display:block;margin:10px 0 5px;font-size:18px}
        .modal-content input,.modal-content select,.modal-content textarea{width:100%;padding:10px;font-size:18px;border:1px solid #ccc;border-radius:5px;box-sizing:border-box}
        .modal-content button{margin-top:20px;padding:12px 24px;font-size:18px;background:#28a745;color:white;border:none;border-radius:5px;cursor:pointer;width:100%;transition:background 0.2s}
        .modal-content button:hover{background:#218838}
        .note{font-size:15px;color:#555;margin-top:15px;line-height:1.4}
        .table-container{margin-top:20px;overflow-x:auto}
        table{width:100%;font-size:14px;border-collapse:collapse}
        th,td{padding:8px;border:1px solid #ccc;white-space:normal;box-sizing:border-box}
        th.vestigial{padding:4px}
        .vestigial{width:36px!important;max-width:36px!important;min-width:0!important;overflow:hidden}
        .vestigial .header-text,.vestigial .cell-content{display:none}
        .editable-row:hover{background:#d9edf7}
        .highlighted-row{background:#ffffcc!important}
        .greyed-out{background:#c0c0c0;cursor:not-allowed}
        @media(max-width:768px){.task-btn{width:100%;margin-bottom:10px}.modal-content{width:95%;max-width:350px}}
        .title-container{display:flex;align-items:baseline;gap:96px;}
        .file-status{font-size:16px;color:#333;}
    </style>
</head>
<body>
    <div class="title-container">
        <h2>Genealogy Recorder <span style="font-size: 14px;">Version: <span id="pageVersion">1.0.16</span></span></h2>
        <span class="file-status" id="fileStatus">No records loaded</span>
    </div>
    <div class="info">
        <p class="warning">Data is deleted when you leave this page. Hit "Return Updates" when complete, to save your changes!</p>
    </div>

    <div class="task-buttons" id="taskButtons">
        <!-- Initial screen: only these two buttons -->
        <button onclick="loadFromDropbox()" class="task-btn" id="selectLoadBtn">Load Records ğŸ“‚</button>
        <button onclick="openRequestModal()" class="task-btn" id="requestEditBtn">Request Edit Package âœ‰ï¸</button>

        <!-- Editing buttons â€“ hidden until records are loaded -->
        <button onclick="openModal('addChild')" class="task-btn disabled-btn" id="addChildBtn" style="display:none">Add Child ğŸ‘¶</button>
        <button onclick="openModal('addSpouse')" class="task-btn disabled-btn" id="addSpouseBtn" style="display:none">Add Partner ğŸ’</button>
        <button onclick="openModal('updateRecord')" class="task-btn disabled-btn" id="updateRecordBtn" style="display:none">Update Record âœï¸</button>
        <button onclick="openModal('recordDeathBurial')" class="task-btn disabled-btn" id="recordDeathBurialBtn" style="display:none">Record Death/Burial âš°ï¸</button>
        <button onclick="toggleTable()" class="task-btn disabled-btn" id="viewTableBtn" style="display:none">View Table ğŸ“‹</button>
        <button onclick="downloadCSV()" class="task-btn" id="returnUpdatesBtn" style="display:none">Return Updates ğŸ“¤</button>
        <button onclick="exitApp()" class="task-btn" id="exitBtn" style="display:none">Exit ğŸšª</button>
    </div>

    <input type="file" id="textFile" accept=".zip,.csv" style="display:none;" onchange="handleFileSelect()">
    <div id="tableContainer" class="table-container" style="display:none;">
        <div id="recordBody"></div>
    </div>

    <div id="modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle"></h3>
            <form id="modalForm" autocomplete="off"></form>
        </div>
    </div>

    <script>
        // ... [all your existing variables and functions up to resetSession remain unchanged] ...

        function resetSession() {
            records = [];
            decryptionPassphrase = null;
            exchangePassphrase = null;
            originalFileName = 'records.zip';
            ticketNumber = null;
            isEncryptedZip = false;
            isInputCsv = false;
            hasReturnedUpdates = false;

            // Show only the two starting buttons
            document.getElementById('selectLoadBtn').style.display = 'block';
            document.getElementById('requestEditBtn').style.display = 'block';

            // Hide all editing buttons
            ['addChildBtn','addSpouseBtn','updateRecordBtn','recordDeathBurialBtn','viewTableBtn','returnUpdatesBtn','exitBtn'].forEach(id =>
                document.getElementById(id).style.display = 'none');

            document.getElementById('fileStatus').textContent = 'No records loaded';
            document.getElementById('textFile').value = '';
            document.getElementById('tableContainer').style.display = 'none';
            document.getElementById('recordBody').innerHTML = '';
        }

        function enableButtonsAfterLoad() {
            // Hide the two starting buttons
            document.getElementById('selectLoadBtn').style.display = 'none';
            document.getElementById('requestEditBtn').style.display = 'none';

            // Show the five editing buttons + Return Updates
            ['addChildBtn','addSpouseBtn','updateRecordBtn','recordDeathBurialBtn','viewTableBtn'].forEach(id => {
                document.getElementById(id).style.display = 'block';
                document.getElementById(id).classList.remove('disabled-btn');
            });
            document.getElementById('returnUpdatesBtn').style.display = 'block';
            if (hasReturnedUpdates) document.getElementById('exitBtn').style.display = 'block';
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Updated Request Modal
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function openRequestModal() {
            safeOpenModal('requestEdit');
            document.getElementById('modalTitle').textContent = 'Request New Edit Package';
            document.getElementById('modalForm').innerHTML = `
                <label>Your Full Name <span style="color:red">*</span></label>
                <input type="text" required>

                <label>Your Email <span style="color:red">*</span></label>
                <input type="email" required>

                <label>Starting Person Full Name (exactly as in the tree) <span style="color:red">*</span></label>
                <input type="text" required>

                <label>Starting Person Birth Year (e.g. 1946) <span style="color:red">*</span></label>
                <input type="text" pattern="[0-9]{4}" placeholder="e.g. 1946" required>

                <label>Your Relationship to This Person (e.g. grandson, niece, self) <span style="color:red">*</span></label>
                <input type="text" required>

                <div class="note">
                    An acknowledgement email containing a passphrase will be sent to the email address above.
                </div>

                <button type="button" onclick="submitEditRequest()">Submit Request</button>
            `;
        }

        async function submitEditRequest() {
            const inputs = document.querySelectorAll('#modalForm input');
            const data = {
                timestamp: new Date().toISOString(),
                requestor_name: inputs[0].value.trim(),
                requestor_email: inputs[1].value.trim(),
                starting_person: inputs[2].value.trim(),
                starting_person_birth_year: inputs[3].value.trim(),
                relationship: inputs[4].value.trim()
            };

            if (Object.values(data).some(v => v === '')) {
                safeShowError('Please fill in all required fields.');
                return;
            }

            try {
                const accessToken = await getAccessToken();
                const dbx = new Dropbox.Dropbox({ accessToken });

                const now = new Date();
                const datePart = now.toISOString().slice(0,10).replace(/-/g,'');
                const timePart = now.toTimeString().slice(0,8).replace(/:/g,'');
                const safeName = data.requestor_name.replace(/[^a-zA-Z0-9]/g, '_').slice(0,20);
                const filename = `requests/${datePart}_${timePart}_${safeName}.json`;

                await dbx.filesUpload({
                    contents: JSON.stringify(data, null, 2),
                    path: DROPBOX_FOLDER + '/' + filename,
                    mode: { '.tag': 'add' },
                    autorename: true
                });

                safeCloseModal();
                showPopup(`
                    <h3 style="color:green">âœ“ Request Submitted Successfully!</h3>
                    <p>Your request has been saved as:<br><b>${filename}</b></p>
                    <p>I will prepare your edit package and send you a passphrase by email shortly.</p>
                `);
            } catch (err) {
                safeShowError('Failed to submit request: ' + err.message);
                console.error(err);
            }
        }

        // ... [rest of your existing script unchanged â€“ all the way to initDebug()] ...
        initDebug();
    </script>
</body>
</html>
