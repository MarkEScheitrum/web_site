<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Genealogy Record Editor</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com;">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous"></script>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;font-size:18px;padding:20px;max-width:100%;margin:0 auto}
        .task-buttons{display:flex;flex-wrap:wrap;gap:15px;justify-content:center;margin-bottom:20px}
        .task-btn{font-size:20px;padding:8px 16px;border-radius:8px;background:#007bff;color:white;border:none;cursor:pointer;min-width:150px;touch-action:manipulation}
        .task-btn:hover:not(.disabled-btn){background:#0056b3}
        .disabled-btn{background:#ccc;cursor:not-allowed;pointer-events:none}
        .file-status{font-size:16px;color:#333;text-align:center;margin-bottom:10px}
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000}
        .modal-content{background:white;padding:20px;border-radius:10px;width:90%;max-width:600px;max-height:80vh;overflow-y:auto}
        .close{float:right;font-size:24px;cursor:pointer}
        .modal-content h3{margin-top:0;font-size:24px}
        .modal-content label{display:block;margin:10px 0 5px;font-size:18px}
        .modal-content input,.modal-content select,.modal-content textarea{width:100%;padding:10px;font-size:18px;border:1px solid #ccc;border-radius:5px;box-sizing:border-box}
        .modal-content button{margin-top:20px;padding:12px 24px;font-size:18px;background:#28a745;color:white;border:none;border-radius:5px;cursor:pointer}
        .modal-content button:hover{background:#218838}
        .table-container{margin-top:20px;overflow-x:auto}
        table{width:100%;font-size:14px;border-collapse:collapse}
        th,td{padding:8px;border:1px solid #ccc;white-space:normal;box-sizing:border-box}
        th.vestigial{padding:4px}
        th.record_type,td.record_type{width:60px}
        th.gen,td.gen{width:40px}
        th.sex,td.sex{width:40px}
        th.record_type.vestigial,td.record_type.vestigial,th.gen.vestigial,td.gen.vestigial,th.name.vestigial,td.name.vestigial,th.sex.vestigial,td.sex.vestigial{width:inherit!important}
        .action-icons{font-size:24px;margin-right:4px}
        .vestigial{width:36px!important;max-width:36px!important;min-width:0!important;overflow:hidden}
        .vestigial .header-text,.vestigial .cell-content{display:none}
        .editable-row:hover{background:#d9edf7}
        .highlighted-row{background:#ffffcc!important}
        .greyed-out{background:#c0c0c0;cursor:not-allowed}
        @media(max-width:768px){.task-btn{width:100%;margin-bottom:10px}.modal-content{width:95%}}
    </style>
</head>
<body>
    <h2>Genealogy Recorder</h2>
    <div class="info">
        <p><strong>Version:</strong> <span id="pageVersion">1.0.5</span> <strong>Last Updated:</strong> <span id="pageDate">2025-11-01 17:22:00 PDT</span></p>
        <p class="warning">Hit "Select/Load File" to start.</p>
        <p class="warning">Data is deleted when you leave this page. Hit "Return Updates" when complete, to save your changes!</p>
    </div>
    <div class="task-buttons">
        <button onclick="selectAndLoadFile()" class="task-btn" id="selectLoadBtn">Select/Load File üìÇ</button>
        <button onclick="openModal('addChild')" class="task-btn disabled-btn" id="addChildBtn">Add Child üë∂</button>
        <button onclick="openModal('addSpouse')" class="task-btn disabled-btn" id="addSpouseBtn">Add Partner üíç</button>
        <button onclick="openModal('updateRecord')" class="task-btn disabled-btn" id="updateRecordBtn">Update Record ‚úèÔ∏è</button>
        <button onclick="openModal('recordDeathBurial')" class="task-btn disabled-btn" id="recordDeathBurialBtn">Record Death/Burial ‚ö∞Ô∏è</button>
        <button onclick="toggleTable()" class="task-btn disabled-btn" id="viewTableBtn">View Table üìã</button>
        <button onclick="downloadCSV()" class="task-btn" id="returnUpdatesBtn" style="display:none;">Return Updates üìß</button>
    </div>
    <div class="file-status">
        <span id="fileStatus">No file selected</span>
    </div>
    <input type="file" id="textFile" accept=".zip,.csv" style="display:none;" onchange="handleFileSelect()">
    <div id="tableContainer" class="table-container" style="display:none;">
        <div id="recordBody"></div>
    </div>
    <div id="modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle"></h3>
            <form id="modalForm"></form>
        </div>
    </div>
    <script>
        let records=[],decryptionPassphrase=null,originalFileName='records.zip';
        let debugMode=false,isInputCsv=false,isEncryptedZip=false;
        let modalMode=null,editingIndex=null,editingField=null,highlightedRow=null;
        let vestigialColumns=new Set(['notes','unprocessed_items']);
        let renderTimeout=null;
        const debugPassphraseHash='0be92202d0978436fce6d8c863f4a2a3d63711a4e4444cb0734beea27315f2a5';
        const dateFields=['birth_date','death_date','marriage_date'];
        const fieldRestrictions={person:{editable:['name','sex','birth_date','birth_location','death_date','death_location','burial_location','service','attributes','parents'],uneditable:['record_type'],greyedOut:['gen','marriage_date','relationship','divorced','divorce date']},spouse:{editable:['name','birth_date','birth_location','death_date','death_location','burial_location','service','marriage_date','relationship','divorce','parents'],uneditable:['record_type'],greyedOut:['gen','sex']}};

        function dateToTimestamp(dateStr){
            if(!dateStr)return Infinity;
            const parts=dateStr.split('-').map(Number);
            if(parts.length===1)return parts[0]*10000*100;
            if(parts.length===2)return parts[0]*10000*100+parts[1]*100;
            return parts[0]*10000*100+parts[1]*100+parts[2];
        }

        window.addEventListener('beforeunload',e=>{if(modalMode){e.preventDefault();e.returnValue='';}});
        window.addEventListener('error',e=>{if(e.message.includes('runtime.lastError')){e.preventDefault();return false;}});

        function selectAndLoadFile(){document.getElementById('textFile').click();}

        function handleFileSelect(){
            const file=document.getElementById('textFile').files[0];
            if(!file)return;
            originalFileName=file.name;
            document.getElementById('fileStatus').textContent=`Selected: ${file.name}`;
            if(debugMode)console.log(`File selected: ${file.name}`);
            const reader=new FileReader();
            reader.onload=e=>processUploadedFile(e.target.result,file.name);
            reader.readAsArrayBuffer(file);
        }

        async function processUploadedFile(buffer,name){
            isEncryptedZip=false;isInputCsv=false;
            try{
                if(debugMode)console.log(`Processing file: ${name}, size: ${buffer.byteLength} bytes`);
                if(name.toLowerCase().endsWith('.zip')){
                    decryptionPassphrase=await askPassphrase(name);
                    if(debugMode)console.log(`Got passphrase for ${name}`);
                    const plainZip=decryptBlob(buffer,decryptionPassphrase);
                    if(debugMode)console.log(`Decrypted ZIP, length: ${plainZip.length} bytes`);
                    await loadZipFromBinary(plainZip);
                    isEncryptedZip=true;
                    finishLoad(`Decrypted ZIP: ${name}`);
                    return;
                }
                if(debugMode&&name.toLowerCase().endsWith('.csv')){
                    if(debugMode)console.log(`Processing CSV: ${name}`);
                    const text=new TextDecoder().decode(buffer);
                    records=parseCSV(text);
                    isInputCsv=true;
                    finishLoad(`Debug CSV: ${name}`);
                    return;
                }
                throw new Error(`Unsupported file. Use .zip${debugMode?' or .csv':''}`);
            }catch(err){
                if(debugMode)console.log(`Error processing file: ${err.message}`);
                safeShowError(err.message);
                document.getElementById('fileStatus').textContent='No file selected';
                document.getElementById('textFile').value='';
            }
        }

        async function loadZipFromBinary(binaryString){
            if(debugMode)console.log(`Loading ZIP, length: ${binaryString.length} bytes`);
            const zip=await JSZip.loadAsync(binaryString,{createFolders:true});
            const csvEntry=Object.values(zip.files).find(f=>f.name.endsWith('.csv'));
            if(!csvEntry)throw new Error("No CSV found in ZIP");
            if(debugMode)console.log(`Found CSV in ZIP: ${csvEntry.name}`);
            const text=await csvEntry.async('text');
            records=parseCSV(text);
        }

        function askPassphrase(fileName){
            return new Promise(resolve=>{
                safeOpenModal('passphrase');
                document.getElementById('modalTitle').textContent=`Passphrase for ${fileName}`;
                document.getElementById('modalForm').innerHTML=`
                    <label>Passphrase</label>
                    <input type="password" id="pp" autofocus onkeydown="if(event.key === 'Enter'){event.preventDefault();resolvePass();}">
                    <button type="button" onclick="resolvePass()">Submit</button>
                `;
                window.resolvePass=()=>{
                    const pp=document.getElementById('pp').value;
                    if(pp){safeCloseModal();resolve(pp);}else{safeShowError('Passphrase required');}
                };
            });
        }

        function finishLoad(msg){
            enableButtonsAfterLoad();
            debounceDisplayRecords();
            document.getElementById('fileStatus').textContent=msg;
            if(debugMode)console.log(msg);
        }

        function deriveKey(passphrase,salt){
            if(debugMode)console.log(`Deriving key with passphrase length: ${passphrase.length}, salt: ${salt.toString(CryptoJS.enc.Hex)}`);
            return CryptoJS.PBKDF2(passphrase,salt,{keySize:8,iterations:100000,hasher:CryptoJS.algo.SHA256});
        }

        function decryptBlob(arrayBuffer,passphrase){
            try{
                const data=new Uint8Array(arrayBuffer);
                if(debugMode)console.log(`DecryptBlob input: ${data.length} bytes`);
                if(data.length<32)throw new Error("File too short for salt and IV");
                const salt=CryptoJS.lib.WordArray.create(data.slice(0,16));
                const iv=CryptoJS.lib.WordArray.create(data.slice(16,32));
                const ct=CryptoJS.lib.WordArray.create(data.slice(32));
                if(debugMode)console.log(`Salt: ${salt.toString(CryptoJS.enc.Hex)}, IV: ${iv.toString(CryptoJS.enc.Hex)}, Ciphertext: ${ct.sigBytes} bytes`);
                const key=deriveKey(passphrase,salt);
                const decrypted=CryptoJS.AES.decrypt({ciphertext:ct},key,{iv:iv,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.NoPadding});
                if(debugMode)console.log(`Decryption completed, WordArray length: ${decrypted.sigBytes} bytes`);
                const decryptedBytes=CryptoJS.enc.Latin1.stringify(decrypted);
                if(!decryptedBytes){if(debugMode)console.log("Decrypted bytes empty");throw new Error("Decryption failed, likely incorrect passphrase");}
                if(debugMode)console.log(`Decrypted bytes length: ${decryptedBytes.length}`);
                const padLen=decryptedBytes.charCodeAt(decryptedBytes.length-1);
                if(debugMode)console.log(`Padding length: ${padLen}`);
                if(padLen<1||padLen>16||!decryptedBytes.slice(-padLen).split('').every(c=>c.charCodeAt(0)===padLen)){
                    if(debugMode)console.log(`Invalid padding, padLen: ${padLen}, last bytes: ${decryptedBytes.slice(-padLen)}`);
                    throw new Error("Invalid padding");
                }
                const result=decryptedBytes.slice(0,-padLen);
                if(debugMode)console.log(`Final decrypted length: ${result.length} bytes`);
                return result;
            }catch(err){
                if(debugMode)console.error(`DecryptBlob error: ${err.message}`);
                throw new Error("Decryption failed: "+(err.message.includes("padding")||err.message.includes("passphrase")?"Invalid passphrase or corrupted file":err.message));
            }
        }

        function encryptBlob(zipBinaryString,passphrase){
            const salt=CryptoJS.lib.WordArray.random(16);
            const iv=CryptoJS.lib.WordArray.random(16);
            const key=deriveKey(passphrase,salt);
            const len=zipBinaryString.length;
            const padLen=16-(len%16);
            let padded=zipBinaryString;
            for(let i=0;i<padLen;i++)padded+=String.fromCharCode(padLen);
            if(debugMode)console.log(`Encrypting: plaintext=${len}B, padded=${padded.length}B`);
            const wordArray=CryptoJS.enc.Latin1.parse(padded);
            const encrypted=CryptoJS.AES.encrypt(wordArray,key,{iv:iv,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.NoPadding});
            const result=salt.concat(iv).concat(encrypted.ciphertext);
            if(debugMode)console.log(`Encryption complete: ciphertext=${result.sigBytes}B`);
            return result;
        }

        function escapeCSVField(f){
            if(typeof f!=='string')f=String(f);
            if(f.includes('"')||f.includes(','))return `"${f.replace(/"/g,'""')}"`;
            return f;
        }

        function parseCSV(text){
            if(debugMode)console.log(`Parsing CSV, length: ${text.length} bytes`);
            const lines=text.replace(/\r\n|\r/g,'\n').split('\n').filter(l=>l.trim()&&!l.trim().startsWith('#'));
            const headers=parseCSVLine(lines[0]);
            const recs=[];
            for(let i=1;i<lines.length;i++){
                const fields=parseCSVLine(lines[i]);
                if(fields.length===headers.length){
                    const r={};
                    headers.forEach((h,j)=>r[h]=fields[j].trim());
                    recs.push(r);
                }else{
                    if(debugMode)console.log(`Skipped line ${i+1}: field count mismatch (${fields.length} vs ${headers.length})`);
                }
            }
            if(debugMode)console.log(`Parsed ${recs.length} records`);
            return recs;
        }

        function parseCSVLine(line){
            const fields=[];
            let field='';
            let inQuotes=false;
            for(let i=0;i<line.length;i++){
                const char=line[i];
                if(char==='"'){inQuotes=!inQuotes;continue;}
                if(char===','&&!inQuotes){fields.push(field);field='';continue;}
                field+=char;
            }
            fields.push(field);
            return fields;
        }

        function buildCSV(){
            if(!records.length)return '';
            const headers=Object.keys(records[0]);
            const rows=[headers.map(escapeCSVField)];
            records.forEach(r=>rows.push(headers.map(h=>escapeCSVField(r[h]||''))));
            return rows.join('\r\n')+'\r\n';
        }

        async function downloadCSV(){
            if(!records.length)return safeShowError('No data to download');
            if(!isInputCsv&&!decryptionPassphrase)return safeShowError('No passphrase available');
            if(debugMode)console.log(`Building CSV for download`);
            const csv=buildCSV();
            let blob,ext,mime;
            if(isInputCsv){
                if(debugMode)console.log(`Generating CSV output: ${csv.length} bytes`);
                blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
                ext='csv';
                mime='text/csv';
            }else{
                if(debugMode)console.log(`Generating ZIP with CSV: ${csv.length} bytes`);
                const zip=new JSZip();
                const csvFileName=originalFileName.replace(/\.zip.*$/i,'')+'.csv';
                zip.file(csvFileName,csv);
                const zipBin=await zip.generateAsync({type:'uint8array'});
                if(debugMode)console.log(`ZIP generated: ${zipBin.length} bytes`);
                const encrypted=encryptBlob(String.fromCharCode.apply(null,zipBin),decryptionPassphrase);
                const uint8=new Uint8Array(encrypted.sigBytes);
                for(let i=0;i<encrypted.sigBytes;i++){
                    const w=encrypted.words[Math.floor(i/4)];
                    uint8[i]=(w>>>(24-(i%4)*8))&0xFF;
                }
                blob=new Blob([uint8],{type:'application/octet-stream'});
                ext='zip';
                mime='application/zip';
            }
            const base=originalFileName.replace(/\.(zip|csv).*$/i,'');
            const dlName=`edited_${base}.${ext}`;
            const a=document.createElement('a');
            a.href=URL.createObjectURL(blob);
            a.download=dlName;
            a.click();
            URL.revokeObjectURL(a.href);
            const body=`Attach "${dlName}" from your Downloads folder.\n\nSteps:\n1. Find "${dlName}" in Downloads\n2. Attach and send`;
            setTimeout(()=>{window.location.href=`mailto:markscheitrum@aol.com?subject=Updated%20Genealogy%20Records&body=${encodeURIComponent(body)}`;},100);
            showPopup(`Downloaded "${dlName}" to your Downloads folder.<br><br>Your email client should have opened with a new email to <strong>markscheitrum@aol.com</strong>.<br>Follow the instructions in the email to attach "${dlName}" and send.<br><br><strong>If the email didn't open:</strong><br>1. Open your email client (e.g., <a href="https://mail.aol.com">AOL Mail</a>, <a href="https://outlook.live.com">Outlook</a>).<br>2. Create a new email to <strong>markscheitrum@aol.com</strong> with subject <strong>Updated Genealogy Records</strong>.<br>3. Attach "${dlName}" from your Downloads folder and send.`);
            if(debugMode)console.log(`Downloaded ${dlName}`);
        }

        function enableButtonsAfterLoad(){
            ['addChildBtn','addSpouseBtn','updateRecordBtn','recordDeathBurialBtn','viewTableBtn'].forEach(id=>document.getElementById(id).classList.remove('disabled-btn'));
            document.getElementById('selectLoadBtn').style.display='none';
            document.getElementById('returnUpdatesBtn').style.display='block';
            if(debugMode)console.log('Enabled task buttons');
        }

        function safeOpenModal(mode){
            if(window.location.search&&!window.location.search.includes('debug=1'))window.history.replaceState({},document.title,window.location.pathname);
            modalMode=mode;
            const modal=document.getElementById('modal');
            modal.style.display='block';
            const modalForm=document.getElementById('modalForm');
            modalForm.innerHTML='';
            modalForm.addEventListener('submit',e=>{e.preventDefault();e.stopPropagation();return false;});
            if(debugMode)console.log(`Opened modal for ${mode}`);
        }

        function safeCloseModal(){
            document.getElementById('modal').style.display='none';
            modalMode=null;
            document.getElementById('modalForm').innerHTML='';
            if(debugMode)console.log('Closed modal');
        }

        function safeShowError(message){
            if(debugMode)console.error(`Error: ${message}`);
            const errorDiv=document.createElement('div');
            errorDiv.style.cssText='position:fixed;top:20px;right:20px;background:#dc3545;color:white;padding:15px;border-radius:5px;z-index:2000;max-width:300px;box-shadow:0 2px 10px rgba(0,0,0,0.2);font-size:14px';
            errorDiv.innerHTML=`<strong>Error</strong><br>${message}<button onclick="this.parentElement.remove()" style="margin-left:10px;background:none;border:none;color:white;cursor:pointer;float:right">&times;</button>`;
            document.body.appendChild(errorDiv);
            setTimeout(()=>errorDiv.remove(),5000);
        }

        function showPopup(html){
            const div=document.createElement('div');
            div.style='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border:1px solid #000;z-index:10000';
            div.innerHTML=html+'<br><button onclick="this.parentElement.remove()">Close</button>';
            document.body.appendChild(div);
        }

        function isValidDate(dateStr){
            if(!dateStr||dateStr.trim()==='')return true;
            const parts=dateStr.split('-');
            if(parts.length===1){
                const year=parseInt(parts[0],10);
                return !isNaN(year)&&year>=1&&year<=9999;
            }else if(parts.length===2){
                const year=parseInt(parts[0],10);
                const month=parseInt(parts[1],10);
                return !isNaN(year)&&year>=1&&year<=9999&&!isNaN(month)&&month>=1&&month<=12;
            }else if(parts.length===3){
                const date=Date.parse(dateStr+'T00:00:00');
                if(isNaN(date))return false;
                const parsedDate=new Date(date);
                return parsedDate.getFullYear()==parts[0]&&(parsedDate.getMonth()+1)==parts[1]&&parsedDate.getDate()==parts[2];
            }
            return false;
        }

        function openModal(mode){
            safeOpenModal(mode);
            const modalTitle=document.getElementById('modalTitle');
            const modalForm=document.getElementById('modalForm');
            let fields=[];
            if(mode==='addChild'){
                modalTitle.textContent='Add Child';
                const selectablePeople=records.filter((r,index)=>{
                    if(index===0&&r.record_type.toLowerCase()==='person')return false;
                    if(r.record_type.toLowerCase()==='spouse'){
                        let nextPersonIndex=records.findIndex((rec,i)=>i>index&&rec.record_type.toLowerCase()==='person');
                        if(nextPersonIndex===-1)nextPersonIndex=records.length;
                        return index>0&&index<nextPersonIndex&&records[0].record_type.toLowerCase()==='person';
                    }
                    return true;
                }).filter(r=>r.record_type.toLowerCase()==='person');
                fields=[
                    {name:'parents',label:'Genealogical Parent Name',type:'select',options:['',...selectablePeople.map(r=>r.name)],required:true},
                    {name:'name',label:'Name',type:'text',autocomplete:'off',required:true},
                    {name:'sex',label:'Sex',type:'select',options:['','male','female']},
                    {name:'birth_date',label:'Birth Date (YYYY-MM-DD or YYYY-MM or YYYY)',type:'text'},
                    {name:'birth_location',label:'Birth Location',type:'text'}
                ];
            }else if(mode==='addSpouse'){
                modalTitle.textContent='Add Partner';
                const selectablePeople=records.filter((r,index)=>{
                    if(index===0&&r.record_type.toLowerCase()==='person')return false;
                    if(r.record_type.toLowerCase()==='spouse'){
                        let nextPersonIndex=records.findIndex((rec,i)=>i>index&&rec.record_type.toLowerCase()==='person');
                        if(nextPersonIndex===-1)nextPersonIndex=records.length;
                        return index>0&&index<nextPersonIndex&&records[0].record_type.toLowerCase()==='person';
                    }
                    return true;
                }).filter(r=>r.record_type.toLowerCase()==='person');
                fields=[
                    {name:'partner',label:'Select Genealogical Partner',type:'select',options:['',...selectablePeople.map(r=>r.name)],required:true},
                    {name:'relationship',label:'Relationship',type:'select',options:['','spouse','partner','other'],required:true},
                    {name:'name',label:'Name',type:'text',autocomplete:'off',required:true},
                    {name:'birth_date',label:'Birth Date (YYYY-MM-DD or YYYY-MM or YYYY)',type:'text'},
                    {name:'birth_location',label:'Birth Location',type:'text'},
                    {name:'marriage_date',label:'Marriage Date (YYYY-MM-DD or YYYY-MM or YYYY)',type:'text'},
                    {name:'parents',label:'Parents',type:'text',autocomplete:'off'}
                ];
            }else if(mode==='updateRecord'){
                modalTitle.textContent='Update Record';
                fields=[
                    {name:'record',label:'Select Record',type:'select',options:['',...records.map(r=>`${r.record_type.toLowerCase()==='spouse'?'Partner':r.record_type}: ${r.name}`)],required:true},
                    {name:'field',label:'Field to Update',type:'select',options:['']},
                    {name:'value',label:'New Value',type:'text',required:true}
                ];
            }else if(mode==='recordDeathBurial'){
                modalTitle.textContent='Record Death/Burial';
                fields=[
                    {name:'record',label:'Select Record',type:'select',options:['',...records.map(r=>`${r.record_type.toLowerCase()==='spouse'?'Partner':r.record_type}: ${r.name}`)],required:true},
                    {name:'death_date',label:'Death Date (YYYY-MM-DD or YYYY-MM or YYYY)',type:'text'},
                    {name:'death_location',label:'Death Location',type:'text'},
                    {name:'burial_location',label:'Burial Location',type:'text'}
                ];
            }
            fields.forEach(field=>{
                const label=document.createElement('label');
                label.textContent=field.label;
                if(field.required)label.innerHTML+=' <span style="color:red">*</span>';
                modalForm.appendChild(label);
                if(field.type==='select'){
                    const select=document.createElement('select');
                    select.name=field.name;
                    if(field.required)select.required=true;
                    field.options.forEach(opt=>{
                        const option=document.createElement('option');
                        option.value=opt;
                        option.textContent=opt||'(Select)';
                        select.appendChild(option);
                    });
                    modalForm.appendChild(select);
                }else{
                    const input=document.createElement(field.type==='textarea'?'textarea':'input');
                    input.type=field.type;
                    input.name=field.name;
                    if(field.required)input.required=true;
                    if(field.autocomplete)input.setAttribute('autocomplete',field.autocomplete);
                    modalForm.appendChild(input);
                }
            });
            const submitBtn=document.createElement('button');
            submitBtn.type='button';
            submitBtn.textContent='Save';
            submitBtn.onclick=()=>{
                if(submitBtn.disabled)return;
                submitBtn.disabled=true;
                setTimeout(()=>submitBtn.disabled=false,1000);
                saveModalData(mode);
            };
            modalForm.appendChild(submitBtn);
            if(mode==='updateRecord'){
                const recordSelect=modalForm.querySelector('select[name="record"]');
                const fieldSelect=modalForm.querySelector('select[name="field"]');
                recordSelect.addEventListener('change',()=>{
                    const selectedRecord=recordSelect.value;
                    if(!selectedRecord){
                        fieldSelect.innerHTML='<option value=""></option>';
                        return;
                    }
                    const [recordType,name]=selectedRecord.split(': ');
                    const cleanType=recordType.toLowerCase()==='partner'?'spouse':'person';
                    const editableFields=[...fieldRestrictions[cleanType].editable];
                    fieldSelect.innerHTML='';
                    const emptyOption=document.createElement('option');
                    emptyOption.value='';
                    fieldSelect.appendChild(emptyOption);
                    editableFields.forEach(f=>{
                        const option=document.createElement('option');
                        option.value=f;
                        option.textContent=f;
                        fieldSelect.appendChild(option);
                    });
                    fieldSelect.value='';
                    fieldSelect.addEventListener('change',()=>{
                        const valueInput=modalForm.querySelector('[name="value"]');
                        if(fieldSelect.value==='attributes'&&cleanType==='person'){
                            const newSelect=document.createElement('select');
                            newSelect.name='value';
                            newSelect.required=true;
                            ['','stillborn','step','foster','adopted','continuation'].forEach(opt=>{
                                const option=document.createElement('option');
                                option.value=opt;
                                option.textContent=opt||'(None)';
                                newSelect.appendChild(option);
                            });
                            valueInput.replaceWith(newSelect);
                        }else if(fieldSelect.value==='sex'&&cleanType==='person'){
                            const newSelect=document.createElement('select');
                            newSelect.name='value';
                            newSelect.required=true;
                            ['','male','female'].forEach(opt=>{
                                const option=document.createElement('option');
                                option.value=opt;
                                option.textContent=opt||'(Select)';
                                newSelect.appendChild(option);
                            });
                            valueInput.replaceWith(newSelect);
                        }else if(fieldSelect.value==='relationship'&&cleanType==='spouse'){
                            const newSelect=document.createElement('select');
                            newSelect.name='value';
                            newSelect.required=true;
                            ['','spouse','partner','other'].forEach(opt=>{
                                const option=document.createElement('option');
                                option.value=opt;
                                option.textContent=opt||'(Select)';
                                newSelect.appendChild(option);
                            });
                            valueInput.replaceWith(newSelect);
                        }else if(valueInput.tagName==='SELECT'){
                            const newInput=document.createElement('input');
                            newInput.type='text';
                            newInput.name='value';
                            newInput.required=true;
                            valueInput.replaceWith(newInput);
                        }
                    });
                });
            }
        }

        function closeModal(){safeCloseModal();}

        function saveModalData(mode){
            try{
                const form=document.getElementById('modalForm');
                const data={};
                for(let input of form.elements){
                    if(input.name&&input.type!=='button')data[input.name]=input.value||'';
                }
                if(debugMode)console.log(`Processing ${mode} with data:`,data);
                if(mode==='addChild'){
                    if(!data.name||!data.parents){safeShowError('Name and Parent are required.');return;}
                    const parent=records.find(r=>r.name===data.parents&&r.record_type.toLowerCase()==='person');
                    if(!parent){safeShowError('Invalid parent selected.');return;}
                    if(data.birth_date&&!isValidDate(data.birth_date)){safeShowError('Invalid birth date. Use YYYY, YYYY-MM, or YYYY-MM-DD.');return;}
                    const parentGen=parseInt(parent.gen)||0;
                    const newRecord={record_type:'Person',gen:(parentGen+1).toString(),name:data.name,sex:data.sex||'',birth_date:data.birth_date||'',birth_location:data.birth_location||'',parents:data.parents||'',death_date:'',death_location:'',burial_location:'',service:'',marriage_date:'',relationship:'',divorce:'',attributes:'',unprocessed_items:'',notes:''};
                    let insertIndex=records.indexOf(parent)+1;
                    while(insertIndex<records.length&&records[insertIndex].record_type.toLowerCase()==='spouse')insertIndex++;
                    const children = records.slice(insertIndex).filter((r, i, arr) => r.record_type.toLowerCase() === 'person' && (i + insertIndex === records.length - 1 || records[i + insertIndex + 1].record_type.toLowerCase() === 'person'));
                    if(debugMode)console.log(`Found ${children.length} children for parent ${parent.name}`);
                    if(children.length>0&&data.birth_date){
                        const newTimestamp=dateToTimestamp(data.birth_date);
                        if(debugMode)console.log(`New child birth_date: ${data.birth_date}, timestamp: ${newTimestamp}`);
                        const sortedChildren=children.map((child,i)=>({index:i+insertIndex,ts:dateToTimestamp(child.birth_date)})).sort((a,b)=>a.ts-b.ts);
                        if(debugMode)console.log(`Sorted children:`,sortedChildren);
                        const insertPos=sortedChildren.findIndex(c=>c.ts>newTimestamp);
                        insertIndex=insertPos===-1?sortedChildren[sortedChildren.length-1].index+1:sortedChildren[insertPos].index;
                        if(debugMode)console.log(`Inserting child at index ${insertIndex}`);
                    }
                    records.splice(insertIndex,0,newRecord);
                    if(debugMode)console.log('Added child record:',newRecord,`at index ${insertIndex}`);
                }else if(mode==='addSpouse'){
                    if(!data.name||!data.partner||!data.relationship){safeShowError('Name, Select Genealogical Partner, and Relationship are required.');return;}
                    const partner=records.find(r=>r.name===data.partner&&r.record_type.toLowerCase()==='person');
                    if(!partner){safeShowError('Invalid partner selected.');return;}
                    if(data.birth_date&&!isValidDate(data.birth_date)){safeShowError('Invalid birth date. Use YYYY, YYYY-MM, or YYYY-MM-DD.');return;}
                    if(data.marriage_date&&!isValidDate(data.marriage_date)){safeShowError('Invalid marriage date. Use YYYY, YYYY-MM, or YYYY-MM-DD.');return;}
                    const newRecord={record_type:'Spouse',gen:'',name:data.name,sex:'',birth_date:data.birth_date||'',birth_location:data.birth_location||'',parents:data.parents||'',death_date:'',death_location:'',burial_location:'',service:'',marriage_date:data.marriage_date||'',relationship:data.relationship,divorce:'',attributes:'',unprocessed_items:'',notes:''};
                    let insertIndex=records.indexOf(partner)+1;
                    const spouses = records.slice(insertIndex).filter((r, i, arr) => r.record_type.toLowerCase() === 'spouse' && (i + insertIndex === records.length - 1 || records[i + insertIndex + 1].record_type.toLowerCase() !== 'spouse'));
                    if(debugMode)console.log(`Found ${spouses.length} spouses for partner ${partner.name}`);
                    if(spouses.length>0&&data.marriage_date){
                        const newTimestamp=dateToTimestamp(data.marriage_date);
                        if(debugMode)console.log(`New spouse marriage_date: ${data.marriage_date}, timestamp: ${newTimestamp}`);
                        const sortedSpouses=spouses.map((spouse,i)=>({index:i+insertIndex,ts:dateToTimestamp(spouse.marriage_date)})).sort((a,b)=>a.ts-b.ts);
                        if(debugMode)console.log(`Sorted spouses:`,sortedSpouses);
                        const insertPos=sortedSpouses.findIndex(s=>s.ts>newTimestamp);
                        insertIndex=insertPos===-1?sortedSpouses[sortedSpouses.length-1].index+1:sortedSpouses[insertPos].index;
                        if(debugMode)console.log(`Inserting spouse at index ${insertIndex}`);
                    }
                    records.splice(insertIndex,0,newRecord);
                    if(debugMode)console.log('Added spouse record:',newRecord,`at index ${insertIndex}`);
                }else if(mode==='updateRecord'){
                    if(!data.record||!data.field){safeShowError('Please select a record and field.');return;}
                    if(!data.value&&data.field!=='attributes'&&data.field!=='sex'){safeShowError('Please enter a value.');return;}
                    const [recordType,name]=data.record.split(': ');
                    const record=records.find(r=>(r.record_type.toLowerCase()==='spouse'?'Partner':r.record_type)===recordType&&r.name===name);
                    if(!record){safeShowError('Invalid record selected.');return;}
                    if(data.field==='relationship'&&!['','spouse','partner','other'].includes(data.value)){safeShowError('Relationship must be "spouse", "partner", or "other".');return;}
                    if(data.field==='attributes'&&!['','stillborn','step','foster','adopted','continuation'].includes(data.value)){safeShowError('Attributes must be one of: None, stillborn, step, foster, adopted, continuation.');return;}
                    if(data.field==='sex'&&!['','male','female'].includes(data.value)){safeShowError('Sex must be one of: male, female, or empty.');return;}
                    if(data.field==='divorce'&&data.value&&data.value!=='true'&&!isValidDate(data.value)){safeShowError('Divorce must be a valid date, "true", or empty.');return;}
                    if(dateFields.includes(data.field)&&data.value&&!isValidDate(data.value)){safeShowError('Invalid date. Use YYYY, YYYY-MM, or YYYY-MM-DD.');return;}
                    const cleanType=recordType.toLowerCase()==='partner'?'spouse':'person';
                    const isEditable=fieldRestrictions[cleanType].editable.includes(data.field);
                    if(isEditable){
                        const oldValue=record[data.field];
                        record[data.field]=data.value;
                        if(debugMode)console.log(`Updated ${data.field} from "${oldValue}" to "${data.value}" for ${name}`);
                    }else{
                        safeShowError('Selected field is not editable.');
                        return;
                    }
                }else if(mode==='recordDeathBurial'){
                    if(!data.record){safeShowError('Please select a record.');return;}
                    const [recordType,name]=data.record.split(': ');
                    const record=records.find(r=>(r.record_type.toLowerCase()==='spouse'?'Partner':r.record_type)===recordType&&r.name===name);
                    if(!record){safeShowError('Invalid record selected.');return;}
                    if(data.death_date&&!isValidDate(data.death_date)){safeShowError('Invalid death date. Use YYYY, YYYY-MM, or YYYY-MM-DD.');return;}
                    let updated=false;
                    if(data.death_date&&isFieldEditable(record.record_type,'death_date')){record.death_date=data.death_date;updated=true;}
                    if(data.death_location&&isFieldEditable(record.record_type,'death_location')){record.death_location=data.death_location;updated=true;}
                    if(data.burial_location&&isFieldEditable(record.record_type,'burial_location')){record.burial_location=data.burial_location;updated=true;}
                    if(!updated){safeShowError('At least one field (Death Date, Death Location, or Burial Location) must be provided and editable.');return;}
                    if(debugMode)console.log(`Updated death/burial info for ${name}`);
                }
                safeCloseModal();
                debounceDisplayRecords();
                if(debugMode)console.log(`Saved ${mode} data:`,data);
            }catch(error){
                if(debugMode)console.error(`Error in saveModalData(${mode}):`,error);
                safeShowError(`An unexpected error occurred: ${error.message}`);
            }
        }

        function toggleTable(){
            const tableContainer=document.getElementById('tableContainer');
            const isHidden=tableContainer.style.display==='none';
            tableContainer.style.display=isHidden?'block':'none';
            if(isHidden&&records.length>0)debounceDisplayRecords();
            if(debugMode)console.log(`Table toggled: ${isHidden?'shown':'hidden'}`);
        }

        function debounceDisplayRecords(){
            if(renderTimeout)clearTimeout(renderTimeout);
            renderTimeout=setTimeout(displayRecords,16);
        }

        function toggleColumn(column){
            if(vestigialColumns.has(column)){
                vestigialColumns.delete(column);
                if(debugMode)console.log(`Restored column: ${column}`);
            }else{
                vestigialColumns.add(column);
                if(debugMode)console.log(`Collapsed column: ${column}`);
            }
            debounceDisplayRecords();
        }

        function isFieldEditable(recordType,field){
            const cleanType=recordType?recordType.toString().trim().toLowerCase():'';
            const restrictions=fieldRestrictions[cleanType];
            if(!restrictions){if(debugMode)console.log(`No restrictions for record_type='${cleanType}', field=${field}`);return false;}
            if(cleanType==='person'&&field==='parents'){if(debugMode)console.log(`Field 'parents' is not editable in table for record_type='person'`);return false;}
            const isEditable=restrictions.editable.includes(field)&&field!=='attributes'&&field!=='sex';
            if(debugMode)console.log(`Checking editable: record_type='${cleanType}', field=${field}, isEditable=${isEditable}`);
            return isEditable;
        }

        function isFieldGreyedOut(recordType,field){
            const cleanType=recordType?recordType.toString().trim().toLowerCase():'';
            const restrictions=fieldRestrictions[cleanType];
            if(!restrictions){if(debugMode)console.log(`No restrictions for record_type='${cleanType}', field=${field}`);return false;}
            const isGreyedOut=restrictions.greyedOut.includes(field);
            if(debugMode)console.log(`Checking greyed-out: record_type='${cleanType}', field=${field}, isGreyedOut=${isGreyedOut}`);
            return isGreyedOut;
        }

        function displayRecords(){
            const recordBody=document.getElementById('recordBody');
            recordBody.innerHTML='';
            if(records.length===0){if(debugMode)console.log('No records to display');return;}
            if(debugMode)console.log(`Displaying ${records.length} records`);
            const table=document.createElement('table');
            const headerRow=document.createElement('tr');
            const headers=Object.keys(records[0]).filter(header=>!['notes','unprocessed_items'].includes(header));
            headers.forEach(header=>{
                const th=document.createElement('th');
                th.className=header;
                if(!['record_type','gen','name','sex'].includes(header)){
                    const toggleButton=document.createElement('span');
                    toggleButton.textContent=vestigialColumns.has(header)?'üëÅÔ∏è‚Äçüó®Ô∏è':'üëÅÔ∏è';
                    toggleButton.className='action-icons';
                    toggleButton.onclick=()=>toggleColumn(header);
                    th.appendChild(toggleButton);
                }
                const headerText=document.createElement('span');
                headerText.textContent=header==='record_type'?'record':header==='sex'?'sex':header;
                headerText.className='header-text';
                th.appendChild(headerText);
                if(vestigialColumns.has(header)&&!['record_type','gen','name','sex'].includes(header))th.className+=' vestigial';
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);
            records.forEach((record,index)=>{
                const tr=document.createElement('tr');
                if(index===highlightedRow)tr.className='highlighted-row';
                tr.className+=' editable-row';
                headers.forEach(header=>{
                    const td=document.createElement('td');
                    td.className=header;
                    const cellContent=document.createElement('span');
                    const displayValue=header==='record_type'&&record[header].toLowerCase()==='spouse'?'Partner':header==='sex'?(record[header]||''):record[header]||'';
                    cellContent.textContent=displayValue;
                    cellContent.className='cell-content';
                    td.appendChild(cellContent);
                    const isEditable=isFieldEditable(record.record_type,header);
                    const isGrey=isFieldGreyedOut(record.record_type,header);
                    if(isEditable&&!vestigialColumns.has(header)){
                        td.className+=' editable';
                        td.addEventListener('click',e=>{
                            if(editingIndex===null){
                                startEditing(index,header,td,cellContent.textContent);
                                e.stopPropagation();
                                if(debugMode)console.log(`Cell clicked: record ${index+1}, field ${header}`);
                            }
                        });
                    }else if(isGrey){
                        td.className+=' greyed-out';
                    }
                    if(vestigialColumns.has(header)&&!['record_type','gen','name','sex'].includes(header))td.className+=' vestigial';
                    tr.appendChild(td);
                });
                tr.addEventListener('click',e=>{
                    if(editingIndex===null&&e.target.tagName!=='TEXTAREA'&&e.target.tagName!=='SELECT'){
                        highlightedRow=(highlightedRow===index)?null:index;
                        if(debugMode)console.log(`Row ${highlightedRow!==null?highlightedRow+1:'none'} highlighted`);
                        debounceDisplayRecords();
                    }
                });
                table.appendChild(tr);
            });
            recordBody.appendChild(table);
            if(debugMode)console.log(`Displayed ${records.length} records`);
        }

        function startEditing(index,field,td,currentValue){
            editingIndex=index;
            editingField=field;
            td.innerHTML='';
            if(field==='relationship'&&records[index].record_type.toLowerCase()==='spouse'){
                const select=document.createElement('select');
                select.className='edit-select';
                ['','spouse','partner','other'].forEach(opt=>{
                    const option=document.createElement('option');
                    option.value=opt;
                    option.textContent=opt||'(Select)';
                    if(opt===currentValue)option.selected=true;
                    select.appendChild(option);
                });
                td.appendChild(select);
                select.focus();
                if(debugMode)console.log(`Started editing record ${index+1}, field: ${field} with dropdown`);
                select.onchange=()=>saveEdit(index,field,select.value,td,currentValue);
                select.onblur=()=>saveEdit(index,field,select.value,td,currentValue);
                select.onkeydown=e=>{
                    if(e.key==='Enter'){
                        e.preventDefault();
                        saveEdit(index,field,select.value,td,currentValue);
                    }else if(e.key==='Escape'){
                        cancelEdit(td,currentValue);
                    }
                };
            }else{
                const textarea=document.createElement('textarea');
                textarea.className='edit-textarea';
                textarea.value=currentValue;
                textarea.rows=Math.max(2,currentValue.split('\n').length);
                td.appendChild(textarea);
                textarea.focus();
                if(debugMode)console.log(`Started editing record ${index+1}, field: ${field} with textarea`);
                textarea.onblur=()=>saveEdit(index,field,textarea.value,td,currentValue);
                textarea.onkeydown=e=>{
                    if(e.key==='Enter'&&!e.shiftKey){
                        e.preventDefault();
                        saveEdit(index,field,textarea.value,td,currentValue);
                    }else if(e.key==='Escape'){
                        cancelEdit(td,currentValue);
                    }
                };
            }
        }

        function saveEdit(index,field,value,td,originalValue){
            const trimmedValue=value.trim();
            if(dateFields.includes(field)&&trimmedValue&&trimmedValue!=='true'&&!isValidDate(trimmedValue)){
                safeShowError(`Invalid date format for ${field}. Use YYYY, YYYY-MM, or YYYY-MM-DD.`);
                cancelEdit(td,originalValue);
                return;
            }
            if(field==='relationship'&&!['','spouse','partner','other'].includes(trimmedValue)){
                safeShowError('Relationship must be "spouse", "partner", or "other".');
                cancelEdit(td,originalValue);
                return;
            }
            if(trimmedValue!==originalValue){
                records[index][field]=trimmedValue;
                if(debugMode)console.log(`Saved edit: record ${index+1}, field ${field}, value ${trimmedValue}`);
            }
            editingIndex=null;
            editingField=null;
            td.innerHTML='';
            const cellContent=document.createElement('span');
            cellContent.textContent=trimmedValue;
            cellContent.className='cell-content';
            td.appendChild(cellContent);
            debounceDisplayRecords();
        }

        function cancelEdit(td,originalValue){
            editingIndex=null;
            editingField=null;
            td.innerHTML='';
            const cellContent=document.createElement('span');
            cellContent.textContent=originalValue;
            cellContent.className='cell-content';
            td.appendChild(cellContent);
            if(debugMode)console.log('Cancelled edit');
            debounceDisplayRecords();
        }

        function initDebug(){
            if(window.location.search.includes('debug=1')){
                (async()=>{
                    const pp=await askPassphrase('DEBUG');
                    if(CryptoJS.SHA256(pp).toString()===debugPassphraseHash){
                        debugMode=true;
                        console.log('DEBUG MODE ON');
                        document.getElementById('textFile').setAttribute('accept','.zip,.csv');
                    }else{
                        console.log('Debug mode disabled - incorrect passphrase');
                    }
                    decryptionPassphrase=null;
                })();
            }
        }
        initDebug();
    </script>
    <!-- END OF FILE: COMPLETE -->
</body>
</html>
