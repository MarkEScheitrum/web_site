<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Genealogy Record Editor</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com;">
    <meta http-equiv="Cache-Control" content="no-store">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* [Your existing CSS unchanged - omitted for brevity] */
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;font-size:18px;padding:20px;max-width:100%;margin:0 auto}
        .task-buttons{display:flex;flex-wrap:wrap;gap:15px;justify-content:center;margin-bottom:20px}
        .task-btn{font-size:20px;padding:8px 16px;border-radius:8px;background:#007bff;color:white;border:none;cursor:pointer;min-width:150px}
        .task-btn:hover:not(.disabled-btn){background:#0056b3}
        .disabled-btn{background:#ccc;cursor:not-allowed;pointer-events:none}
        .file-status{font-size:16px;color:#333;text-align:center;margin-bottom:10px}
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000}
        .modal-content{background:white;padding:20px;border-radius:10px;width:90%;max-width:600px;max-height:80vh;overflow-y:auto}
        .close{float:right;font-size:24px;cursor:pointer}
        .modal-content h3{margin-top:0;font-size:24px}
        .modal-content label{display:block;margin:10px 0 5px;font-size:18px}
        .modal-content input,.modal-content select,.modal-content textarea{width:100%;padding:10px;font-size:18px;border:1px solid #ccc;border-radius:5px;box-sizing:border-box}
        .modal-content button{margin-top:20px;padding:12px 24px;font-size:18px;background:#28a745;color:white;border:none;border-radius:5px;cursor:pointer}
        .modal-content button:hover{background:#218838}
        .table-container{margin-top:20px;overflow-x:auto}
        table{width:100%;font-size:14px;border-collapse:collapse}
        th,td{padding:8px;border:1px solid #ccc;white-space:normal}
        .vestigial{width:36px!important;max-width:36px!important;min-width:0!important;overflow:hidden}
        .vestigial .header-text,.vestigial .cell-content{display:none}
        .editable-row:hover{background:#d9edf7}
        .highlighted-row{background:#ffffcc!important}
        .greyed-out{background:#c0c0c0;cursor:not-allowed}
        @media(max-width:768px){.task-btn{width:100%;margin-bottom:10px}}
    </style>
</head>
<body>
    <h2>Genealogy Recorder</h2>
    <div class="info">
        <p><strong>Version:</strong> <span id="pageVersion">1.0.2</span> <strong>Last Updated:</strong> <span id="pageDate">2025-11-01 10:38:00 PST</span></p>
        <p class="warning">Hit "Select/Load File" to start.</p>
        <p class="warning">Data is deleted when you leave this page. Hit "Return Updates" when done!</p>
    </div>
    <div class="task-buttons">
        <button onclick="openModal('addChild')" class="task-btn disabled-btn" id="addChildBtn">Add Child üë∂</button>
        <button onclick="openModal('addSpouse')" class="task-btn disabled-btn" id="addSpouseBtn">Add Partner üíç</button>
        <button onclick="openModal('updateRecord')" class="task-btn disabled-btn" id="updateRecordBtn">Update Record ‚úèÔ∏è</button>
        <button onclick="openModal('recordDeathBurial')" class="task-btn disabled-btn" id="recordDeathBurialBtn">Record Death/Burial ‚ö∞Ô∏è</button>
        <button onclick="toggleTable()" class="task-btn disabled-btn" id="viewTableBtn">View Table üìã</button>
        <button onclick="selectAndLoadFile()" class="task-btn" id="selectLoadBtn">Select/Load File üìÇ</button>
        <button onclick="downloadCSV()" class="task-btn" id="returnUpdatesBtn" style="display:none">Return Updates üìß</button>
    </div>
    <div class="file-status"><span id="fileStatus">No file selected</span></div>
    <input type="file" id="textFile" accept=".zip,.csv" style="display:none" onchange="handleFileSelect()">
    <div id="tableContainer" class="table-container" style="display:none"><div id="recordBody"></div></div>

    <div id="modal" class="modal" style="display:none">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle"></h3>
            <form id="modalForm"></form>
        </div>
    </div>

    <script>
        let records = [], decryptionPassphrase = null, originalFileName = 'records.zip';
        let debugMode = false, isInputCsv = false, isEncryptedZip = false;
        const debugPassphraseHash = '0be92202d0978436fce6d8c863f4a2a3d63711a4e4444cb0734beea27315f2a5';

        // ---------- CRYPTO (EXACT PYTHON MATCH) ----------
        function deriveKey(passphrase, salt) {
            return CryptoJS.PBKDF2(passphrase, salt, {
                keySize: 8, iterations: 100000, hasher: CryptoJS.algo.SHA256
            });
        }

        function decryptBlob(arrayBuffer, passphrase) {
            const data = new Uint8Array(arrayBuffer);
            if (data.length < 32) throw new Error("File too short");
            const salt = CryptoJS.enc.Latin1.parse(data.slice(0,16));
            const iv   = CryptoJS.enc.Latin1.parse(data.slice(16,32));
            const ct   = CryptoJS.enc.Latin1.parse(data.slice(32));
            const key  = deriveKey(passphrase, salt);
            const decrypted = CryptoJS.AES.decrypt({ciphertext: ct}, key, {
                iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.NoPadding
            });
            const padded = CryptoJS.enc.Latin1.parse(decrypted.toString(CryptoJS.enc.Base64));
            const padLen = padded.words[padded.words.length-1] & 0xFF;
            if (padLen < 1 || padLen > 16) throw new Error("Bad padding");
            return padded.toString(CryptoJS.enc.Latin1).slice(0, -padLen);
        }

        function encryptBlob(zipBinaryString, passphrase) {
            const salt = CryptoJS.lib.WordArray.random(16);
            const iv   = CryptoJS.lib.WordArray.random(16);
            const key  = deriveKey(passphrase, salt);

            // Manual PKCS#7-style padding
            const len = zipBinaryString.length;
            const padLen = 16 - (len % 16);
            let padded = zipBinaryString;
            for (let i = 0; i < padLen; i++) padded += String.fromCharCode(padLen);

            const wordArray = CryptoJS.enc.Latin1.parse(padded);
            const encrypted = CryptoJS.AES.encrypt(wordArray, key, {
                iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.NoPadding
            });

            return salt.concat(iv).concat(encrypted.ciphertext);
        }

        // ---------- FILE HANDLING ----------
        function selectAndLoadFile() { document.getElementById('textFile').click(); }

        function handleFileSelect() {
            const file = document.getElementById('textFile').files[0];
            if (!file) return;
            originalFileName = file.name;
            document.getElementById('fileStatus').textContent = `Selected: ${file.name}`;
            const reader = new FileReader();
            reader.onload = e => processUploadedFile(e.target.result, file.name);
            reader.readAsArrayBuffer(file);
        }

        async function processUploadedFile(buffer, name) {
            isEncryptedZip = false; isInputCsv = false;

            try {
                // 1. Try as encrypted ZIP
                if (name.toLowerCase().endsWith('.zip')) {
                    const zip = await JSZip.loadAsync(buffer);
                    const csvEntry = Object.values(zip.files).find(f => f.name.endsWith('.csv'));
                    if (csvEntry) {
                        if (debugMode) {
                            const text = await csvEntry.async('text');
                            records = parseCSV(text);
                            finishLoad(`Debug CSV from ${name}`);
                            isInputCsv = true;
                            return;
                        } else {
                            // Encrypted ZIP: whole file is encrypted blob
                            decryptionPassphrase = await askPassphrase(name);
                            const plainZip = decryptBlob(buffer, decryptionPassphrase);
                            await loadZipFromBinary(plainZip);
                            isEncryptedZip = true;
                            finishLoad(`Decrypted ZIP: ${name}`);
                            return;
                        }
                    }
                }

                // 2. Plain CSV (debug only)
                if (debugMode && name.toLowerCase().endsWith('.csv')) {
                    const text = new TextDecoder().decode(buffer);
                    records = parseCSV(text);
                    finishLoad(`Debug CSV: ${name}`);
                    isInputCsv = true;
                    return;
                }

                throw new Error(`Unsupported file. Use .zip (encrypted) or .csv (debug)`);
            } catch (err) {
                safeShowError(err.message);
                document.getElementById('fileStatus').textContent = 'No file selected';
                document.getElementById('textFile').value = '';
            }
        }

        async function loadZipFromBinary(binaryString) {
            const zip = await JSZip.loadAsync(binaryString, {createFolders: true});
            const csvEntry = Object.values(zip.files).find(f => f.name.endsWith('.csv'));
            if (!csvEntry) throw new Error("No CSV found in ZIP");
            const text = await csvEntry.async('text');
            records = parseCSV(text);
        }

        function askPassphrase(fileName) {
            return new Promise(resolve => {
                safeOpenModal('passphrase');
                document.getElementById('modalTitle').textContent = `Passphrase for ${fileName}`;
                document.getElementById('modalForm').innerHTML = `
                    <label>Passphrase</label>
                    <input type="password" id="pp" autofocus>
                    <button type="button" onclick="resolvePass()">Submit</button>
                `;
                window.resolvePass = () => {
                    const pp = document.getElementById('pp').value;
                    if (pp) { safeCloseModal(); resolve(pp); }
                    else safeShowError('Passphrase required');
                };
            });
        }

        function finishLoad(msg) {
            enableButtonsAfterLoad();
            debounceDisplayRecords();
            document.getElementById('fileStatus').textContent = msg;
        }

        // ---------- CSV ----------
        function parseCSV(text) {
            const lines = text.replace(/\r\n/g, '\n').split('\n').filter(l => l.trim());
            const headers = lines[0].split(',').map(h => h.replace(/^"|"$/g, '').replace(/""/g, '"'));
            const recs = [];
            for (let i = 1; i < lines.length; i++) {
                const r = {};
                const fields = lines[i].split(',').map(f => f.replace(/^"|"$/g, '').replace(/""/g, '"'));
                headers.forEach((h, j) => r[h] = fields[j] || '');
                recs.push(r);
            }
            return recs;
        }

        function buildCSV() {
            if (!records.length) return '';
            const headers = Object.keys(records[0]);
            const rows = [headers.map escapeCSVField];
            records.forEach(r => rows.push(headers.map(h => escapeCSVField(r[h] || ''))));
            return rows.join('\r\n') + '\r\n';
        }
        function escapeCSVField(f) {
            if (f.includes('"') || f.includes(',')) return `"${f.replace(/"/g, '""')}"`;
            return f;
        }

        // ---------- DOWNLOAD ----------
        async function downloadCSV() {
            if (!records.length) return safeShowError('No data');

            const csv = buildCSV();
            let blob, ext, mime;

            if (isInputCsv) {
                blob = new Blob([csv], {type: 'text/csv'});
                ext = 'csv';
                mime = 'text/csv';
            } else {
                // Re-encrypt whole ZIP
                const zip = new JSZip();
                const csvFileName = originalFileName.replace(/\.zip.*$/i, '') + '.csv';
                zip.file(csvFileName, csv);
                const zipBin = await zip.generateAsync({type: 'uint8array'});
                const encrypted = encryptBlob(String.fromCharCode.apply(null, zipBin), decryptionPassphrase);
                const uint8 = new Uint8Array(encrypted.sigBytes);
                for (let i = 0; i < encrypted.sigBytes; i++) {
                    const w = encrypted.words[Math.floor(i/4)];
                    uint8[i] = (w >>> (24 - (i%4)*8)) & 0xFF;
                }
                blob = new Blob([uint8], {type: 'application/octet-stream'});
                ext = 'zip';
                mime = 'application/zip';
            }

            const base = originalFileName.replace(/\.(zip|csv).*$/i, '');
            const dlName = `edited_${base}.${ext}`;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = dlName;
            a.click();
            URL.revokeObjectURL(a.href);

            const body = `Attach "${dlName}" from your Downloads folder.\n\n` +
                        `Steps:\n1. Open Downloads\n2. Find "${dlName}"\n3. Attach & Send`;
            setTimeout(() => {
                window.location.href = `mailto:markscheitrum@aol.com?subject=Updated Genealogy Records&body=${encodeURIComponent(body)}`;
            }, 500);

            showPopup(`Downloaded "${dlName}"<br>Email client should open.<br>Attach the file and send.`);
        }

        // ---------- UI ----------
        function enableButtonsAfterLoad() {
            ['addChildBtn','addSpouseBtn','updateRecordBtn','recordDeathBurialBtn','viewTableBtn'].forEach(id =>
                document.getElementById(id).classList.remove('disabled-btn'));
            document.getElementById('selectLoadBtn').style.display = 'none';
            document.getElementById('returnUpdatesBtn').style.display = 'block';
        }

        // [All your existing modal / table / editing code unchanged - omitted for brevity]
        // ... (openModal, saveModalData, displayRecords, etc.)
        // Just copy-paste your original functions below this line

        // ---------- DEBUG MODE ----------
        function initDebug() {
            if (location.search.includes('debug=1')) {
                (async () => {
                    const pp = await askPassphrase('DEBUG');
                    if (CryptoJS.SHA256(pp).toString() === debugPassphraseHash) {
                        debugMode = true;
                        console.log('DEBUG MODE ON');
                        document.getElementById('textFile').accept = '.zip,.csv';
                    }
                    decryptionPassphrase = null;
                })();
            }
        }
        initDebug();

        // ---------- MODAL HELPERS ----------
        function safeOpenModal(m) { /* your existing */ }
        function safeCloseModal() { document.getElementById('modal').style.display='none'; }
        function safeShowError(msg) { alert(msg); } // replace with your popup
        function showPopup(html) {
            const div = document.createElement('div');
            div.style = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border:1px solid #000;z-index:10000';
            div.innerHTML = html + '<br><button onclick="this.parentElement.remove()">Close</button>';
            document.body.appendChild(div);
        }

        // ---------- DEBOUNCE ----------
        let renderTO;
        function debounceDisplayRecords() {
            clearTimeout(renderTO);
            renderTO = setTimeout(displayRecords, 16);
        }

        // [Paste ALL your existing functions: openModal, saveModalData, displayRecords, startEditing, etc.]
        // They work unchanged.

        // For brevity, here‚Äôs a minimal displayRecords stub:
        function displayRecords() {
            const tbody = document.getElementById('recordBody');
            tbody.innerHTML = '';
            if (!records.length) return;
            const table = document.createElement('table');
            const headers = Object.keys(records[0]);
            const tr = document.createElement('tr');
            headers.forEach(h => { const th = document.createElement('th'); th.textContent = h; tr.appendChild(th); });
            table.appendChild(tr);
            records.forEach(r => {
                const tr = document.createElement('tr');
                headers.forEach(h => {
                    const td = document.createElement('td');
                    td.textContent = r[h] || '';
                    tr.appendChild(td);
                });
                table.appendChild(tr);
            });
            tbody.appendChild(table);
        }
    </script>
</body>
</html>
