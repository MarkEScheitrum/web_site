<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Genealogy Record Editor</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://unpkg.com;">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js" crossorigin="anonymous"></script>
    <script src="config.js"></script>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;font-size:18px;padding:20px;max-width:100%;margin:0 auto}
        .task-buttons{display:flex;flex-wrap:wrap;gap:15px;justify-content:center;margin-bottom:20px}
        .task-btn{font-size:18px;padding:7.2px 14.4px;border-radius:7.2px;background:#007bff;color:white;border:none;cursor:pointer;min-width:135px;touch-action:manipulation}
        .task-btn:hover:not(.disabled-btn){background:#0056b3}
        .disabled-btn{background:#ccc;cursor:not-allowed;pointer-events:none}
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000}
        .modal-content{background:white;padding:20px;border-radius:10px;width:90%;max-width:420px;max-height:80vh;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,0.2)}
        .close{float:right;font-size:24px;cursor:pointer}
        .modal-content h3{margin-top:0;font-size:24px;text-align:center}
        .modal-content label{display:block;margin:10px 0 5px;font-size:18px}
        .modal-content input,.modal-content select,.modal-content textarea{width:100%;padding:10px;font-size:18px;border:1px solid #ccc;border-radius:5px;box-sizing:border-box}
        .modal-content button{margin-top:20px;padding:12px 24px;font-size:18px;background:#28a745;color:white;border:none;border-radius:5px;cursor:pointer;width:100%;transition:background 0.2s}
        .modal-content button:hover{background:#218838}
        .note{font-size:15px;color:#555;margin-top:20px;line-height:1.4;background:#f8f9fa;padding:12px;border-radius:6px}
        .table-container{margin-top:20px;overflow-x:auto;display:block;width:100%;border:1px solid #ddd;border-radius:4px}
        .table-container::-webkit-scrollbar{height:12px}
        .table-container::-webkit-scrollbar-track{background:#f1f1f1;border-radius:10px}
        .table-container::-webkit-scrollbar-thumb{background:#888;border-radius:10px}
        .table-container::-webkit-scrollbar-thumb:hover{background:#555}
        table{width:100%;font-size:16px;border-collapse:collapse;min-width:1600px}
        th,td{padding:10px;border:1px solid #ccc;white-space:normal;box-sizing:border-box;text-align:left}
        th.vestigial,td.vestigial{width:36px!important;max-width:36px!important;min-width:36px!important;overflow:hidden;text-align:center;padding:4px!important}
        th.vestigial > *:not(.eye), td.vestigial > *{display:none!important}
        th.record_type,td.record_type{width:80px}
        th.gen,td.gen{width:60px;text-align:center}
        th.sex,td.sex{width:60px;text-align:center}
        .editable-row:hover{background:#d9edf7}
        .highlighted-row{background:#ffffcc!important}
        .greyed-out{background:#c0c0c0;cursor:not-allowed}
        @media(max-width:768px){.task-btn{width:100%;margin-bottom:10px}.modal-content{width:95%;max-width:350px}}
        .title-container{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:20px}
        .title-left{flex:1}
        .title-right{text-align:right}
        .status-line{margin-top:8px;font-size:16px;color:#333;display:block}
    </style>
</head>
<body>
    <div class="title-container">
        <div class="title-left">
            <h2>Genealogy Recorder
                <span style="font-size:14px;">
                    Version: <span id="pageVersion">1.0.38</span> ‚Äî November 21, 2025
                </span>
            </h2>
            <span class="status-line" id="fileStatus">No records loaded</span>
        </div>
        <div class="title-right">
            <button onclick="openIssueModal()" class="task-btn" style="background:#0066cc;font-size:16px;padding:8px 16px;min-width:auto">Provide Feedback üó®Ô∏è</button>
        </div>
    </div>

    <div class="info">
        <p class="warning">Data is deleted when you leave this page. Hit "Return Updates" when complete, to save your changes!</p>
    </div>

    <div class="task-buttons" id="taskButtons">
        <button onclick="loadFromDropbox()" class="task-btn" id="selectLoadBtn">Load Records üìÇ</button>
        <button onclick="openRequestModal()" class="task-btn" id="requestEditBtn">Request Edit Package ‚úâÔ∏è</button>
        <button onclick="openModal('addChild')" class="task-btn disabled-btn" id="addChildBtn" style="display:none">Add Child üë∂</button>
        <button onclick="openModal('addSpouse')" class="task-btn disabled-btn" id="addSpouseBtn" style="display:none">Add Partner üíç</button>
        <button onclick="openModal('updateRecord')" class="task-btn disabled-btn" id="updateRecordBtn" style="display:none">Update Record ‚úèÔ∏è</button>
        <button onclick="openModal('recordDeathBurial')" class="task-btn disabled-btn" id="recordDeathBurialBtn" style="display:none">Record Death/Burial ‚ö∞Ô∏è</button>
        <button onclick="toggleTable()" class="task-btn disabled-btn" id="viewTableBtn" style="display:none">View Table üìã</button>
        <button onclick="downloadCSV()" class="task-btn" id="returnUpdatesBtn" style="display:none">Return Updates üì§</button>
        <button onclick="exitApp()" class="task-btn" id="exitBtn" style="display:none">Exit üö™</button>
    </div>

    <input type="file" id="textFile" accept=".zip" style="display:none;" onchange="handleFileSelect()">
    <div id="tableContainer" class="table-container" style="display:none;">
        <div id="recordBody"></div>
    </div>

    <div id="modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle"></h3>
            <form id="modalForm" autocomplete="off"></form>
        </div>
    </div>

    <script>
        let records = [], decryptionPassphrase = null, exchangePassphrase = null, originalFileName = 'records.zip';
        let debugMode = false, isEncryptedZip = false;
        let modalMode = null;
        let vestigialColumns = new Set(['notes', 'unprocessed_items', 'hash_id', 'record_id', 'parent_ids', 'children_no_other_parent']);
        let renderTimeout = null;
        let ticketNumber = null;
        let hasReturnedUpdates = false;
        const DROPBOX_FOLDER = '';

        const fieldRestrictions = {
            person: {
                editable: ['name', 'sex', 'birth_date', 'birth_location', 'death_date', 'death_location', 'burial_location', 'service', 'attributes', 'parents'],
                greyedOut: ['gen', 'marriage_date', 'relationship', 'divorced', 'divorce date']
            },
            spouse: {
                editable: ['name', 'birth_date', 'birth_location', 'death_date', 'death_location', 'burial_location', 'service', 'marriage_date', 'relationship', 'divorce', 'parents'],
                greyedOut: ['gen', 'sex']
            }
        };

        async function getAccessToken() {
            try {
                const response = await fetch('https://api.dropboxapi.com/oauth2/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        grant_type: 'refresh_token',
                        refresh_token: DROPBOX_REFRESH_TOKEN,
                        client_id: DROPBOX_APP_KEY,
                        client_secret: DROPBOX_APP_SECRET
                    })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error_description || 'Failed to refresh access token');
                return data.access_token;
            } catch (err) {
                throw new Error('Unable to authenticate with Dropbox');
            }
        }

        function safeOpenModal(mode) {
            modalMode = mode;
            document.getElementById('modal').style.display = 'block';
            document.getElementById('modalForm').innerHTML = '';
        }

        function safeCloseModal() {
            document.getElementById('modal').style.display = 'none';
            modalMode = null;
            document.getElementById('modalForm').innerHTML = '';
        }

        function safeShowError(message) {
            const div = document.createElement('div');
            div.style.cssText = 'position:fixed;top:20px;right:20px;background:#dc3545;color:white;padding:15px;border-radius:5px;z-index:2000;max-width:300px;box-shadow:0 2px 10px rgba(0,0,0,0.2);font-size:14px';
            div.innerHTML = `<strong>Error</strong><br>${message}<button onclick="this.parentElement.remove()" style="margin-left:10px;background:none;border:none;color:white;cursor:pointer;float:right">√ó</button>`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 6000);
        }

        function showPopup(html) {
            const div = document.createElement('div');
            div.style = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border:1px solid #000;z-index:10000;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.3);max-width:90%';
            div.innerHTML = html + '<br><button onclick="this.parentElement.remove()" style="margin-top:15px;padding:8px 16px">Close</button>';
            document.body.appendChild(div);
        }

        async function loadFromDropbox() {
            const passphrase = await askPassphrase('File Retrieval');
            if (!passphrase) return;
            exchangePassphrase = passphrase;
            decryptionPassphrase = passphrase;

            try {
                const accessToken = await getAccessToken();
                const dbx = new Dropbox.Dropbox({ accessToken });
                const fileHash = CryptoJS.SHA256(passphrase).toString();

                const response = await dbx.filesListFolder({ path: DROPBOX_FOLDER });
                const fileEntry = response.result.entries
                    .filter(e => e.name.startsWith(fileHash) && e.name.endsWith('.zip'))
                    .sort((a, b) => b.name.localeCompare(a.name))[0];

                if (!fileEntry) {
                    safeShowError('No file found in Dropbox for the provided passphrase.');
                    return;
                }

                const fileResponse = await dbx.filesDownload({ path: fileEntry.path_display });
                const buffer = await fileResponse.result.fileBlob.arrayBuffer();
                const plainZip = decryptBlob(buffer, passphrase);

                const zip = await JSZip.loadAsync(plainZip);
                const jsonEntry = Object.values(zip.files).find(f => f.name.endsWith('.json'));
                if (!jsonEntry) throw new Error('No records JSON found in ZIP');

                originalFileName = fileEntry.name;
                const match = jsonEntry.name.match(/records_(\d{5})\.json/);
                ticketNumber = match ? match[1] : 'Unknown';
                document.getElementById('fileStatus').textContent = `Ticket ${ticketNumber} Records Loaded`;

                const text = await jsonEntry.async('text');
                const data = JSON.parse(text);
                records = data.data || data;
                isEncryptedZip = true;
                finishLoad();
            } catch (err) {
                safeShowError(`Failed to load: ${err.message}`);
                resetSession();
            }
        }

        function askPassphrase(promptText) {
            return new Promise(resolve => {
                safeOpenModal('passphrase');
                document.getElementById('modalTitle').textContent = `Enter Passphrase for ${promptText}`;
                document.getElementById('modalForm').innerHTML = `
                    <label>Passphrase</label>
                    <input type="password" id="pp" autocomplete="off" data-lpignore="true" autofocus>
                    <button type="button" onclick="window.resolvePass()">Submit</button>
                `;
                window.resolvePass = () => {
                    const val = document.getElementById('pp').value;
                    safeCloseModal();
                    resolve(val || null);
                };
            });
        }

        function resetSession() {
            records = [];
            decryptionPassphrase = null;
            exchangePassphrase = null;
            originalFileName = 'records.zip';
            ticketNumber = null;
            isEncryptedZip = false;
            hasReturnedUpdates = false;
            document.getElementById('selectLoadBtn').style.display = 'block';
            document.getElementById('requestEditBtn').style.display = 'block';
            ['addChildBtn','addSpouseBtn','updateRecordBtn','recordDeathBurialBtn','viewTableBtn','returnUpdatesBtn','exitBtn'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            document.getElementById('fileStatus').textContent = 'No records loaded';
            document.getElementById('tableContainer').style.display = 'none';
            document.getElementById('recordBody').innerHTML = '';
        }

        function enableButtonsAfterLoad() {
            document.getElementById('selectLoadBtn').style.display = 'none';
            document.getElementById('requestEditBtn').style.display = 'none';
            ['addChildBtn','addSpouseBtn','updateRecordBtn','recordDeathBurialBtn','viewTableBtn'].forEach(id => {
                document.getElementById(id).style.display = 'block';
                document.getElementById(id).classList.remove('disabled-btn');
            });
            document.getElementById('returnUpdatesBtn').style.display = 'block';
        }

        function finishLoad() {
            enableButtonsAfterLoad();
            debounceDisplayRecords();
        }

        function exitApp() {
            if (confirm("Are you sure you want to exit? Any unsaved changes will be lost.")) {
                resetSession();
            }
        }

        // ==================== ENCRYPTION / DECRYPTION ====================
        function deriveKey(passphrase, salt) {
            return CryptoJS.PBKDF2(passphrase, salt, { keySize: 8, iterations: 100000, hasher: CryptoJS.algo.SHA256 });
        }

        function decryptBlob(arrayBuffer, passphrase) {
            const data = new Uint8Array(arrayBuffer);
            if (data.length < 32) throw new Error("File too short");
            const salt = CryptoJS.lib.WordArray.create(data.slice(0, 16));
            const iv = CryptoJS.lib.WordArray.create(data.slice(16, 32));
            const ct = CryptoJS.lib.WordArray.create(data.slice(32));
            const key = deriveKey(passphrase, salt);
            const decrypted = CryptoJS.AES.decrypt({ ciphertext: ct }, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.NoPadding });
            const decryptedBytes = CryptoJS.enc.Latin1.stringify(decrypted);
            const padLen = decryptedBytes.charCodeAt(decryptedBytes.length - 1);
            if (padLen < 1 || padLen > 16) throw new Error("Invalid padding");
            return decryptedBytes.slice(0, -padLen);
        }

        function encryptBlob(zipBinaryString, passphrase) {
            const salt = CryptoJS.lib.WordArray.random(16);
            const iv = CryptoJS.lib.WordArray.random(16);
            const key = deriveKey(passphrase, salt);
            const len = zipBinaryString.length;
            const padLen = 16 - (len % 16);
            let padded = zipBinaryString;
            for (let i = 0; i < padLen; i++) padded += String.fromCharCode(padLen);
            const wordArray = CryptoJS.enc.Latin1.parse(padded);
            const encrypted = CryptoJS.AES.encrypt(wordArray, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.NoPadding });
            return salt.concat(iv).concat(encrypted.ciphertext);
        }

        // ==================== RETURN UPDATES ====================
        async function downloadCSV() {
            if (!records.length) return safeShowError('No data to save');

            const output = {
                header: { generator: "recorder.html", version: "1.0.38", date: new Date().toISOString() },
                data: records
            };

            const zip = new JSZip();
            zip.file(`records_${ticketNumber || 'unknown'}.json`, JSON.stringify(output, null, 2));

            const zipBin = await zip.generateAsync({ type: 'uint8array' });
            const encrypted = encryptBlob(String.fromCharCode.apply(null, zipBin), decryptionPassphrase);
            const uint8 = new Uint8Array(encrypted.sigBytes);
            for (let i = 0; i < encrypted.sigBytes; i++) {
                const w = encrypted.words[Math.floor(i / 4)];
                uint8[i] = (w >>> (24 - (i % 4) * 8)) & 0xFF;
            }
            const blob = new Blob([uint8], { type: 'application/octet-stream' });

            try {
                const accessToken = await getAccessToken();
                const dbx = new Dropbox.Dropbox({ accessToken });
                const fileHash = CryptoJS.SHA256(exchangePassphrase).toString();
                const timestamp = new Date().toISOString().replace(/[-:T.]/g, '').slice(0, 14);
                const dropboxPath = `${DROPBOX_FOLDER}/${fileHash}_edited_${timestamp}.zip`;

                await dbx.filesUpload({ contents: blob, path: dropboxPath, mode: 'overwrite' });
                showPopup(`Updated file saved to Dropbox`);
                hasReturnedUpdates = true;
                document.getElementById('exitBtn').style.display = 'block';
                document.getElementById('fileStatus').textContent = `Ticket ${ticketNumber} Records Returned`;
            } catch (err) {
                safeShowError(`Failed to upload: ${err.message}`);
            }
        }

        // ==================== MODALS ====================
        function openModal(mode) {
            safeOpenModal(mode);
            const modalTitle = document.getElementById('modalTitle');
            const modalForm = document.getElementById('modalForm');
            let fields = [];

            if (mode === 'addChild') {
                modalTitle.textContent = 'Add Child';
                const selectablePeople = records.filter(r => !r.record_type || r.record_type.toLowerCase() === 'person');
                fields = [
                    { name: 'parents', label: 'Genealogical Parent Name', type: 'select', options: ['', ...selectablePeople.map(r => r.name || '(no name)')], required: true },
                    { name: 'name', label: 'Name', type: 'text', required: true },
                    { name: 'sex', label: 'Sex', type: 'select', options: ['', 'male', 'female'] },
                    { name: 'birth_date', label: 'Birth Date (YYYY-MM-DD or YYYY-MM or YYYY)', type: 'text' },
                    { name: 'birth_location', label: 'Birth Location', type: 'text' }
                ];
            } else if (mode === 'addSpouse') {
                modalTitle.textContent = 'Add Partner';
                const selectablePeople = records.filter(r => !r.record_type || r.record_type.toLowerCase() === 'person');
                fields = [
                    { name: 'partner', label: 'Select Genealogical Partner', type: 'select', options: ['', ...selectablePeople.map(r => r.name || '(no name)')], required: true },
                    { name: 'relationship', label: 'Relationship', type: 'select', options: ['', 'spouse', 'partner', 'other'], required: true },
                    { name: 'name', label: 'Name', type: 'text', required: true },
                    { name: 'birth_date', label: 'Birth Date (YYYY-MM-DD or YYYY-MM or YYYY)', type: 'text' },
                    { name: 'birth_location', label: 'Birth Location', type: 'text' },
                    { name: 'marriage_date', label: 'Marriage Date (YYYY-MM-DD or YYYY-MM or YYYY)', type: 'text' },
                    { name: 'parents', label: 'Parents', type: 'text' }
                ];
            } else if (mode === 'updateRecord') {
                modalTitle.textContent = 'Update Record';
                fields = [
                    { name: 'record', label: 'Select Record', type: 'select', options: ['', ...records.map((r, i) => `${i}: ${r.name || '(no name)'}`)], required: true },
                    { name: 'field', label: 'Field to Update', type: 'select', options: [''] },
                    { name: 'value', label: 'New Value', type: 'text', required: true }
                ];
            } else if (mode === 'recordDeathBurial') {
                modalTitle.textContent = 'Record Death/Burial';
                fields = [
                    { name: 'record',365 label: 'Select Record', type: 'select', options: ['', ...records.map((r, i) => `${i}: ${r.name || '(no name)'}`)], required: true },
                    { name: 'death_date', label: 'Death Date (YYYY-MM-DD or YYYY-MM or YYYY)', type: 'text' },
                    { name: 'death_location', label: 'Death Location', type: 'text' },
                    { name: 'burial_location', label: 'Burial Location', type: 'text' }
                ];
            }

            fields.forEach(field => {
                const label = document.createElement('label');
                label.textContent = field.label;
                if (field.required) label.innerHTML += ' <span style="color:red">*</span>';
                modalForm.appendChild(label);
                if (field.type === 'select') {
                    const select = document.createElement('select');
                    select.name = field.name;
                    if (field.required) select.required = true;
                    field.options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = opt || '(Select)';
                        select.appendChild(option);
                    });
                    modalForm.appendChild(select);
                } else {
                    const input = document.createElement(field.type === 'textarea' ? 'textarea' : 'input');
                    input.type = field.type;
                    input.name = field.name;
                    if (field.required) input.required = true;
                    modalForm.appendChild(input);
                }
            });

            const submitBtn = document.createElement('button');
            submitBtn.type = 'button';
            submitBtn.textContent = 'Save';
            submitBtn.onclick = () => saveModalData(mode);
            modalForm.appendChild(submitBtn);
        }

        function closeModal() { safeCloseModal(); }

        function saveModalData(mode) {
            const form = document.getElementById('modalForm');
            const data = {};
            for (let input of form.elements) {
                if (input.name && input.type !== 'button') data[input.name] = input.value || '';
            }

            if (mode === 'addChild') {
                if (!data.name || !data.parents) return safeShowError('Name and Parent required');
                const parentRec = records.find(r => r.name === data.parents);
                if (!parentRec) return safeShowError('Parent not found');
                const newRec = {
                    record_type: 'Person',
                    gen: (parseInt(parentRec.gen) || 0) + 1 + '',
                    name: data.name,
                    sex: data.sex || '',
                    birth_date: data.birth_date || '',
                    birth_location: data.birth_location || '',
                    death_date: '',
                    death_location: '',
                    burial_location: '',
                    burial_notes: '',
                    service: '',
                    marriage_date: '',
                    relationship: '',
                    divorce: '',
                    parents: '',
                    attributes: '',
                    unprocessed_items: '',
                    notes: '',
                    partners: []
                };
                records.push(newRec);
            } else if (mode === 'addSpouse') {
                if (!data.name || !data.partner) return safeShowError('Name and Partner required');
                const partnerRec = records.find(r => r.name === data.partner);
                if (!partnerRec) return safeShowError('Partner not found');
                const newPartner = {
                    name: data.name,
                    birth_date: data.birth_date || '',
                    birth_location: data.birth_location || '',
                    death_date: '',
                    death_location: '',
                    burial_location: '',
                    burial_notes: '',
                    service: '',
                    marriage_date: data.marriage_date || '',
                    relationship: data.relationship || 'spouse',
                    divorce: '',
                    divorced: false,
                    parents: data.parents || '',
                    children: []
                };
                if (!partnerRec.partners) partnerRec.partners = [];
                partnerRec.partners.push(newPartner);
            } else if (mode === 'updateRecord') {
                const idx = parseInt(data.record.split(':')[0]);
                if (isNaN(idx)) return safeShowError('Invalid record');
                records[idx][data.field] = data.value;
            } else if (mode === 'recordDeathBurial') {
                const idx = parseInt(data.record.split(':')[0]);
                if (isNaN(idx)) return safeShowError('Invalid record');
                if (data.death_date) records[idx].death_date = data.death_date;
                if (data.death_location) records[idx].death_location = data.death_location;
                if (data.burial_location) records[idx].burial_location = data.burial_location;
            }

            safeCloseModal();
            debounceDisplayRecords();
        }

        // ==================== TABLE & EDITING ====================
        function toggleTable() {
            const container = document.getElementById('tableContainer');
            container.style.display = container.style.display === 'none' || container.style.display === '' ? 'block' : 'none';
            if (container.style.display === 'block') debounceDisplayRecords();
        }

        function debounceDisplayRecords() {
            if (renderTimeout) clearTimeout(renderTimeout);
            renderTimeout = setTimeout(displayRecords, 16);
        }

        function toggleColumn(column) {
            if (vestigialColumns.has(column)) {
                vestigialColumns.delete(column);
            } else {
                vestigialColumns.add(column);
            }
            debounceDisplayRecords();
        }

        function isFieldEditable(rec, field) {
            const type = (rec.record_type || 'person').toLowerCase();
            const restrictions = fieldRestrictions[type] || fieldRestrictions.person;
            return restrictions.editable.includes(field);
        }

        function displayRecords() {
            const body = document.getElementById('recordBody');
            body.innerHTML = '';
            if (!records.length) return;

            const table = document.createElement('table');
            // Hard-coded columns ‚Äî exactly the old CSV version
            const headers = [
                'gen', 'name', 'sex', 'birth_date', 'birth_location',
                'death_date', 'death_location', 'burial_location', 'burial_notes', 'service',
                'marriage_date', 'relationship', 'divorce', 'parents', 'attributes', 'notes'
            ];

            const hr = document.createElement('tr');
            headers.forEach(h => {
                const th = document.createElement('th');
                th.className = h;
                th.textContent = h.replace(/_/g, ' ');
                // No eye on gen column
                if (h !== 'gen' && !['name','sex'].includes(h)) {
                    const eye = document.createElement('span');
                    eye.className = 'eye';
                    eye.textContent = vestigialColumns.has(h) ? 'üëÅÔ∏è‚Äçüó®Ô∏è' : 'üëÅÔ∏è';
                    eye.style.cursor = 'pointer';
                    eye.style.marginLeft = '8px';
                    eye.onclick = e => { e.stopPropagation(); toggleColumn(h); };
                    th.appendChild(eye);
                }
                hr.appendChild(th);
            });
            table.appendChild(hr);

            records.forEach(rec => {
                const tr = document.createElement('tr');
                headers.forEach(h => {
                    const td = document.createElement('td');
                    if (vestigialColumns.has(h)) td.classList.add('vestigial');
                    if (h === 'gen') td.textContent = rec.generation || '';
                    else td.textContent = rec[h] || '';
                    if (isFieldEditable(rec, h)) {
                        td.style.cursor = 'pointer';
                        td.title = 'Click to edit';
                        td.onclick = () => startEditing(rec, h, td, td.textContent);
                    }
                    tr.appendChild(td);
                });
                table.appendChild(tr);

                rec.partners?.forEach(partner => {
                    const ptr = document.createElement('tr');
                    ptr.style.backgroundColor = '#f8f8f8';
                    headers.forEach(h => {
                        const td = document.createElement('td');
                        if (vestigialColumns.has(h)) td.classList.add('vestigial');
                        if (h === 'record_type') td.textContent = 'Partner';
                        else if (h === 'name') td.textContent = partner.name || '';
                        else if (h === 'marriage_date') td.textContent = partner.marriage_date || '';
                        else if (h === 'relationship') td.textContent = partner.relationship || '';
                        else if (h === 'divorce') td.textContent = partner.divorced ? 'Yes' : (partner.divorce_date || '');
                        else td.textContent = partner[h] || '';
                        if (isFieldEditable({record_type: 'spouse'}, h)) {
                            td.style.cursor = 'pointer';
                            td.title = 'Click to edit';
                        }
                        ptr.appendChild(td);
                    });
                    table.appendChild(ptr);
                });
            });

            body.appendChild(table);
        }

        function startEditing(rec, field, td, currentValue) {
            td.innerHTML = '';
            const textarea = document.createElement('textarea');
            textarea.value = currentValue;
            textarea.rows = 2;
            td.appendChild(textarea);
            textarea.focus();
            textarea.onblur = () => saveEdit(rec, field, textarea.value, td, currentValue);
            textarea.onkeydown = e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    saveEdit(rec, field, textarea.value, td, currentValue);
                } else if (e.key === 'Escape') {
                    cancelEdit(td, currentValue);
                }
            };
        }

        function saveEdit(rec, field, value, td, oldValue) {
            const trimmed = value.trim();
            if (trimmed !== oldValue) rec[field] = trimmed;
            td.innerHTML = trimmed;
            debounceDisplayRecords();
        }

        function cancelEdit(td, oldValue) {
            td.innerHTML = oldValue;
        }

        // ==================== PROVIDE FEEDBACK ====================
        function openIssueModal() {
            safeOpenModal('issue');
            document.getElementById('modalTitle').textContent = 'Provide Feedback';
            document.getElementById('modalForm').innerHTML = `
                <label>Feedback Title <span style="color:red">*</span></label>
                <input type="text" id="issueTitle" required>
                <label>Description <span style="color:red">*</span></label>
                <textarea id="issueDesc" rows="6" required></textarea>
                <button type="button" onclick="submitIssue()">Submit Feedback</button>
            `;
        }

        async function submitIssue() {
            const title = document.getElementById('issueTitle').value.trim();
            const desc = document.getElementById('issueDesc').value.trim();
            if (!title || !desc) {
                safeShowError('Both title and description are required');
                return;
            }

            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const timestamp = `${year}${month}${day}_${hours}${minutes}${seconds}`;

            const data = {
                timestamp: `${year}-${month}-${day} ${hours}:${minutes}:${seconds} PST`,
                ticket_number: ticketNumber || "none",
                feedback_title: title,
                feedback_description: desc
            };

            try {
                const accessToken = await getAccessToken();
                const dbx = new Dropbox.Dropbox({ accessToken });
                const filename = `feedback/feedback_${ticketNumber || 'none'}_${timestamp}.json`;

                await dbx.filesUpload({
                    contents: JSON.stringify(data, null, 2),
                    path: DROPBOX_FOLDER + '/' + filename,
                    mode: { '.tag': 'add' },
                    autorename: true
                });

                safeCloseModal();
                showPopup(`
                    <h3 style="color:green">‚úì Feedback Submitted</h3>
                    <p>Thank you! Your feedback has been saved as:</p>
                    <b>${filename}</b>
                    <p>We appreciate your help improving the editor.</p>
                `);
            } catch (err) {
                safeShowError('Failed to submit feedback: ' + err.message);
            }
        }

        // ==================== REQUEST EDIT PACKAGE ====================
        function openRequestModal() {
            safeOpenModal('requestEdit');
            document.getElementById('modalTitle').textContent = 'Request New Edit Package';
            document.getElementById('modalForm').innerHTML = `
                <label>Your Full Name <span style="color:red">*</span></label>
                <input type="text" required>
                <label>Your Email <span style="color:red">*</span></label>
                <input type="email" required>
                <label>Starting Person Full Name (exactly as in the tree) <span style="color:red">*</span></label>
                <input type="text" required>
                <label>Starting Person Birth Year (e.g. 1946) <span style="color:red">*</span></label>
                <input type="text" pattern="[0-9]{4}" placeholder="e.g. 1946" required>
                <label>Your Relationship to This Person (e.g. grandson, niece, self) <span style="color:red">*</span></label>
                <input type="text" required>
                <div class="note">
                    An acknowledgement email containing a passphrase will be sent to the email address above.
                </div>
                <button type="button" onclick="submitEditRequest()">Submit Request</button>
            `;
        }

        async function submitEditRequest() {
            const inputs = document.querySelectorAll('#modalForm input');
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const tz = now.toLocaleTimeString('en-us', { timeZoneName: 'short' }).split(' ')[2];
            const formattedTimestamp = `${year}-${month}-${day} ${hours}:${minutes}:${seconds} ${tz}`;
            const data = {
                timestamp: formattedTimestamp,
                requestor_name: inputs[0].value.trim(),
                requestor_email: inputs[1].value.trim(),
                starting_person: inputs[2].value.trim(),
                starting_person_birth_year: inputs[3].value.trim(),
                relationship: inputs[4].value.trim()
            };
            if (Object.values(data).some(v => v === '')) {
                safeShowError('Please fill in all required fields.');
                return;
            }
            try {
                const accessToken = await getAccessToken();
                const dbx = new Dropbox.Dropbox({ accessToken });
                const datePart = now.toISOString().slice(0,10).replace(/-/g,'');
                const timePart = now.toTimeString().slice(0,8).replace(/:/g,'');
                const safeName = data.requestor_name.replace(/[^a-zA-Z0-9]/g, '_').slice(0,20);
                const filename = `requests/request_${datePart}_${timePart}_${safeName}.json`;
                await dbx.filesUpload({
                    contents: JSON.stringify(data, null, 2),
                    path: DROPBOX_FOLDER + '/' + filename,
                    mode: { '.tag': 'add' },
                    autorename: true
                });
                safeCloseModal();
                showPopup(`
                    <h3 style="color:green">‚úì Request Submitted Successfully!</h3>
                    <p><strong>Request Time:</strong> ${formattedTimestamp}</p>
                    <p>Your request has been saved as:<br><b>${filename}</b></p>
                    <p>I will prepare your edit package and send you a passphrase by email shortly.</p>
                `);
            } catch (err) {
                safeShowError('Failed to submit request: ' + err.message);
            }
        }

        function initDebug() {
            if (window.location.search.includes('debug=1')) {
                (async () => {
                    const pp = await askPassphrase('DEBUG');
                    if (CryptoJS.SHA256(pp).toString() === '0be92202d0978436fce6d8c863f4a2a3d63711a4e4444cb0734beea27315f2a5') {
                        debugMode = true;
                        console.log('DEBUG MODE ON');
                        document.getElementById('textFile').setAttribute('accept', '.zip');
                    }
                })();
            }
        }
        initDebug();
    </script>
</body>
</html>
